# Многопоточность (Multitherading)

[К оглавлению](./README.md)

## Структура раздела
- [Описание](#desc)
- [Интерфейсы многопоточности в iOS](#muti)
	- [Проблемы многопоточности](#bugs)
	- [Синхронизация данных](#datasync)

## <a id="desc"></a>Описание

Многопоточность позволяет распределять задачи по потокам и одновременно (или последовательно) выполнять их.

### Основные понятия
 
 * __Thread (поток)__ - последовательность инструкций, которая может быть выполнена независимо от отслального кода программы.
 * __Queue (очередь)__ - множество выполняемых задач, абстракция, используемая Apple в GCD и Operation, позволяющая не опускаться на уровень потоков.
 * __Task (задача)__ - набор инструкций (функция или замыкание), которые выполняются в рамках определенной очереди на некотором потоке.

#### Типы многопоточности
 
 * __Parallelism__ - Выполнение нескольких задач в одно и то же время на нескольких процессорных ядрах.
 * __Concurrency__ - выполнение нескольких задач в одно время на одном процессорном ядре с помощью *Context switching*

#### Типы очередей (при работе с Grand Central Dispatch)
 
 * __Serial__ - Текущий поток прекращает встает в режим ожидания до тех пор, пока не будет заверш другой поток.
 * __Concurrent__ - Текущий поток продолжает выполнение паралельно с другим потоком.

#### Quality of Service, QoS - типы приоритетов потоков

 Для каждого потока может быть определен приоритет
 
 * __background__ - самый низкий, когда время выполнения задачи не имеет значения. Например синхронизация или индексация.
 * __utility__ - для слежубных операций, требующих значительного времени для выполнения. Например, импорт или обработка большого количества данных.
 * __default__ - средний приоритет, используется по-умолчанию.
 * __userInitiated__ - высокий приоритет, используется для задачи инициированных пользователем, если он ожидает их немедленного выполнения. Например загрузка полноразмерного изображения при нажатии на превью.
 * __userInteractive__ - самый высокий приоритет. используется для обновления/перемещения элементов интерфейса.
 
## <a id="multi"></a>Интерфейсы многопоточности в iOS
 
#### О них нужно знать

 * [pthread](Multithearding%20-%20pthread) - низкоуровневая работа с потоками с помощью синтаксиса С
 * [Thread class](Multithearding%20-%20Thread) - первый уровень абстракции над pthreads
 * ??? [NSObject](Multithearding%20-%20NSObject) - имеет ряд методов, использующих класс Thread
 
#### Их нужно использовать

 * [Grand Central Dispatch](Multithearding%20-%20GCD)
 * [Operation](Multithearding%20-%20Operation)
 * Async/await & Actors (доступно в iOS 15+)
 
 GCD и Operation тянутся из Objective-C. Первая самостоятельная реализация многопоточности в Swift - это async/await & Actors
 
#### Отличия GCD и Operations

 - Operations могут отменять задачи прямо в процессе исполнения, в то время как GCD может отменить выполнение задачи только до того, как она будет начата.
 
### <a id="bugs"></a>Проблемы многопоточности
 
 * [Race Condition](./Thearding-bugs.md#racecondition)
 * [Deadlock](./Thearding-bugs.md#deadlock)
 * [Livelock](./Thearding-bugs.md#livelock)
 * [Priority Inversion](./Thearding-bugs.md#priority)
 
### <a id="datasync"></a>Синхронизация данных
 
 Используется для обеспечения защиты объектов от некорретных изменений, возникающих из-за одновременного доступа сразу с нескольких потоков.
 
 * Mutex
    * [pthread_mutex_t](Multithearding%20-%20pthread) - мьютексы для pthread_t
    * [NSLock](Multithearding%20-%20NSLock) - блокировки (без условий)
    * NSConditionLock
    * NSDestributedLock
 * Условие
    * [pthread_cond_t](Multithearding%20-%20pthread)
    * [NSCondition](Multithearding%20-%20NSCondition)
 * [Semaphore (Семофор)](Multithearding%20-%20Semaphore)
 * [Барьер (Barrier)](Multithearding%20-%20Barrier)
 * Другие
    * pthread_rwlock_t - read-write lock, защита данных независимо для чтения и записи (реализации в Foundation нет,используем С-шные типы)
    * unfair lock - что был виден, нужно импортировать Darwin, например через Foundation или UIKit. Данный тип блокировки хранит информацию о потоке-владельце, на основе которой ОС пытается в случае необходимости разрешить инверсию приоритетов.
    * objc_sync
    * spin lock - deprecated in iOS 10, заменен на unfair lock
